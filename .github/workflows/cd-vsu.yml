name: cd-vsu-app

on:
  workflow_dispatch:
  push:
    paths:
      - 'vsu-app/**'
      # - 'vsu-cornet/**'
      - '.github/workflows/cd-vsu.yml'

env:
  BUILD_ID: ${{ github.server_url }}!${{ github.repository }}!${{ github.ref_name }}!${{ github.sha }}!${{ github.run_number }}
  IMAGE_NAME: vsu
  IMAGE_ID: ${{ secrets.OCP4_REGISTRY }}/${{ secrets.OCP4_NAMESPACE }}/vsu

jobs:
  build-vsu-app:
    runs-on: ubuntu-latest
    # if: github.repository_owner == 'bcgov'
    env:
      VSU_APP_DOCKERFILE_PATH: ./vsu-app/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx tooling
        uses: docker/setup-buildx-action@v3

      - name: Authenticate and set OpenShift registry context
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OCP4_REGISTRY }}
          openshift_username: ${{ secrets.OCP4_USERNAME }}
          openshift_password: ${{ secrets.OCP4_PASSWORD }}
          namespace: ${{ secrets.OCP4_NAMESPACE }}

      - name: Pull image
        run: docker pull $IMAGE_ID || true

      - name: Build and push vsu-app
        uses: docker/build-push-action@v6
        with:
          build-args: |
            BUILD_ID="${{ env.BUILD_ID }}"
          cache-from: |
            ${{ env.IMAGE_ID }}
          file: ${{ env.VSU_APP_DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:dev
          

  # DEVELOPMENT NOTE
  # It appears that vsu-cornet was never deployed. This job has been commented out in the event that vsu-cornet is ever properly implemented in OpenShift.
  # However, it should be done so separately in its own workflow.
  #
  # build-vsu-cornet:
  #   runs-on: ubuntu-latest
  #   if: github.repository_owner == 'bcgov'
  #   env:
  #     VSU_CORNET_DOCKERFILE_PATH: ./vsu-cornet/Dockerfile

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up Docker Buildx tooling
  #       uses: docker/setup-buildx-action@v3

  #     - name: Pull image
  #       run: docker pull ${{ env.IMAGE_ID }} || true

  #     - name: Build and export vsu-cornet
  #       uses: docker/build-push-action@v6
  #       with:
  #         build-args: |
  #           BUILD_ID="${{ env.BUILD_ID }}"
  #         cache-from: |
  #           ${{ env.IMAGE_ID }}
  #         file: ${{ env.VSU_CORNET_DOCKERFILE_PATH }}
  #         tags: |
  #           $IMAGE_NAME
  #         outputs: type=docker

  #     - name: Build and push vsu-cornet to local registry
  #       uses: docker/build-push-action@v6
  #       with:
  #         push: true
  #         tags: localhost:5000/vsu-cornet:latest

  # build-vsu:
  #   needs: [build-vsu-app]
  #   runs-on: ubuntu-latest
  #   if: github.repository_owner == 'bcgov'

  #   steps:
  #     - uses: actions/checkout@v4


  #     - name: Load vsu-app and vsu-cornet images
  #       run: |
  #         docker load --input /tmp/vsu-app.tar
  #         docker load --input /tmp/vsu-cornet.tar

  #     - name: Log into registry
  #       run: echo "${{ secrets.OCP4_PASSWORD  }}" | docker login ${{ secrets.OCP4_REGISTRY }}/${{ secrets.OCP4_NAMESPACE }} -u ${{ secrets.OCP4_USERNAME  }} --password-stdin

  #     - name: Build image
  #       run: |
  #         echo "BUILD ID=$BUILD_ID"
  #         docker build --tag $IMAGE_NAME --build-arg BUILD_ID="$BUILD_ID" . --file $DOCKERFILE_PATH --cache-from=$IMAGE_ID

  #     - name: Push image
  #       run: |
  #         # Change all uppercase to lowercase
  #         IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

  #         # Strip git ref prefix from version
  #         VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

  #         # Strip "v" prefix from tag name
  #         [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')

  #         # Use Docker `latest` tag convention
  #         [ "$VERSION" == "main" ] && VERSION=latest

  #         echo IMAGE_ID=$IMAGE_ID
  #         echo VERSION=$VERSION

  #         docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
  #         docker push $IMAGE_ID:$VERSION
